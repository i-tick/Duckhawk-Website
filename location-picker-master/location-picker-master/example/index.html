<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Example</title>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC52Z3z1WF_y0Q0dbYfexizoexgAnSTov0"></script>
  <script src="https://unpkg.com/location-picker/dist/location-picker.min.js"></script>
  <style type="text/css">
  
    #map {
      width: 100%;
      height: 480px;
    }
    /* .location-picker .centerMarker {
     
      background-image: url(https://pngimg.com/uploads/pin/pin_PNG101.png);
      
    
    } */
  </style>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.7.0/firebase-app.js"></script>

<script src="https://www.gstatic.com/firebasejs/6.6.0/firebase.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCLQnzejqxqq5jGDz3inOiOsDERwl3vazA",
    authDomain: "calculator-45215.firebaseapp.com",
    databaseURL: "https://calculator-45215.firebaseio.com",
    projectId: "calculator-45215",
    storageBucket: "calculator-45215.appspot.com",
    messagingSenderId: "112038114046",
    appId: "1:112038114046:web:9d0cfdc2b5cd3a5fb7abaf"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

   
  var database = firebase.database();

  // console.log(database);


</script>
</head>

<body>
<div id="map"></div>
<br>
<button id="getCurrent">Get Current Position</button>
<button id="confirmPosition">Confirm Position</button>
<button id="getPath">GetPath</button>
<br>
<p>On idle position: <span id="onIdlePositionView"></span></p>
<p>On click position: <span id="onClickPositionView"></span></p>
<script>
  // Get element references
  var confirmBtn = document.getElementById('confirmPosition');
  var onClickPositionView = document.getElementById('onClickPositionView');
  var onIdlePositionView = document.getElementById('onIdlePositionView');
  var map = document.getElementById('map');

  // Initialize LocationPicker plugin
  var lp = new locationPicker(map, {
    setCurrentPosition: true, // You can omit this, defaults to true
  }, {
    zoom: 18 // You can set any google map options here, zoom defaults to 15
  });

  var getCur = document.getElementById('getCurrent');
  getCur.onclick = function(){
    lp.setCurrentPosition();
  }

  // Listen to button onclick event
  confirmBtn.onclick = function () {
    // Get current location and show it in HTML
    var location = lp.getMarkerPosition();
    onClickPositionView.innerHTML = 'The chosen location is ' + location.lat + ',' + location.lng;
  };

  // Listen to map idle event, listening to idle event more accurate than listening to ondrag event
  google.maps.event.addListener(lp.map, 'idle', function (event) {
    // Get current location and show it in HTML
    var location = lp.getMarkerPosition();
    

    var latitude = location.lat;
    var longitude = location.lng;
    var geocoder;
    geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(latitude, longitude,1);

    geocoder.geocode(
        {'latLng': latlng}, 
        function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              console.log(results,status)
                if (results[0]) {
                    var add= results[0].formatted_address ;
                    var  value=add.split(",");
                    count=value.length;
                    country=value[count-1];
                    state=value[count-2];
                    city=value[count-3];
                    console.log(value);
                   console.log("city name is: " + city);
                   onIdlePositionView.innerHTML = 'The chosen location is ' + location.lat + ',' + location.lng+" "+results[0].formatted_address ;
                }
                else  {
                    console.log("address not found");
                }
            }
            else {
                console.log("Geocoder failed due to: " + status);
            }
        }
    );
     
    function initMap() {
        var directionsRenderer = new google.maps.DirectionsRenderer;
        var directionsService = new google.maps.DirectionsService;
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 18,
          center: {lat: latitude, lng:longitude}
        });
        directionsRenderer.setMap(map);

        calculateAndDisplayRoute(directionsService, directionsRenderer);

        database.ref().on("child_changed", function(snapshot) {
            var changedPost = snapshot.val();
            console.log(snapshot.val());
            console.log("The updated post title is " + changedPost.title);
            calculateAndDisplayRoute(directionsService, directionsRenderer);
      });
        
      }

      var a;
      var b; 
      
      
     
      function calculateAndDisplayRoute(directionsService, directionsRenderer) {

        database.ref().once('value').then(function(snapshot){
            a = snapshot.val().Lat;
            b = snapshot.val().Long;
            console.log(a , b);
        });
          
        var selectedMode = google.maps.TravelMode.DRIVING;
        directionsService.route({
          origin: {lat: latitude, lng: longitude},  
          destination: {lat: a, lng:b },  
          travelMode:selectedMode
        }, function(response, status) {
          if (status == 'OK') {
            directionsRenderer.setDirections(response);  
            // var leg = response.routes[0].legs[0];
            // console.log(leg)
            // var icons = {
            //   start: new google.maps.MarkerImage(
            //     "http://pngimg.com/uploads/motorcycle/motorcycle_PNG3144.png",
            //     new google.maps.Size(44,32),
            //     new google.maps.Point(0,0),
            //     new google.maps.Point(22,32)
            //   )
            // }
            // new google.maps.Marker({
            //   position: leg.start_location,
            //   icon :icons.start,
            //   title : "Start"
            // })
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }

      var getPath = document.getElementById("getPath");
      getPath.onclick = function(){
        initMap();
      }
      


  });


</script>
</body>
</html>
